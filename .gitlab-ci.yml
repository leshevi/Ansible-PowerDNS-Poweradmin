stages:
  - âš’ï¸tool creation
  - ğŸ› ï¸ansible_test
  - ğŸš€deploy

variables:
  DEPENDENCY_IMAGE: "registry.gitlab.com/ansible_playbooks7843206/poweradmin/ansible-basa-ee:latest"
  ANSIBLE_FORCE_COLOR: "1"
  ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3
  ANSIBLE_INVENTORY: inventories
  ANSIBLE_REMOTE_TMP: /tmp
  ANSIBLE_STARATEGY: linear
  ANSIBLE_PIPELINING: 1
  ANSIBLE_TRANSPORT: ssh
  ANSIBLE_BECOME_METHOD: su
  ANSIBLE_BECOME_USER: root
  ANSIBLE_BECOME_ASKPASS: 'False'
  ANSIBLE_FORCE_HANDLER: 'True'
  CALLBACK_PLUGINS: /path/to/ansible/plugins/callback
  ANSIBLE_ASK_PASS: 'False'
  ANSIBLE_NOCOWS: 1
  CALLBACK_RESULT_FORMAT: yaml
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  ANSIBLE_BECOME_EXE: 'sudo -p "Password: " su -'
  ANSIBLE_TIMEOUT: 30
  ANSIBLE_STDOUT_CALLBACK: debug
  ANSIBLE_ROLES_PATH: "$CI_PROJECT_DIR/roles"
  DEPRECATION_WARNINGS: 'False'

image: $DEPENDENCY_IMAGE

ğŸ”¨generate_inventory:
  stage: âš’ï¸tool creation
  tags:
    - Docker
  variables:
    SERVER_IPS: 192.168.1.33
    SERVER_NAMES: web-server
  script:
    - rm .gitlab-ci.yml
    - eval $(ssh-agent -s)
    - echo "$SSH_ROOT_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - |
      cat > hosts.yml << EOF
      ---
      all:
        vars:
          ansible_user: $SSH_USER
      EOF

      # Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… GitLab
      SERVERS_JSON=$SERVERS  # ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ JSON Ğ¼Ğ°ÑÑĞ¸Ğ² ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²

      if [ -n "$SERVERS_JSON" ] && [ "$SERVERS_JSON" != "null" ]; then
        echo "  children:" >> hosts.yml

        # ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€
        echo $(< $SERVERS_JSON) | jq -c '.[]' | while read server; do
          server_name=$(echo "$server" | jq -r '.name')
          server_ip=$(echo "$server" | jq -r '.ip')
          server_groups=$(echo "$server" | jq -r '.groups')

          echo "    $server_groups:" >> hosts.yml
          echo "      hosts:" >> hosts.yml
          echo "        $server_name:" >> hosts.yml
          echo "          ansible_host: $server_ip" >> hosts.yml

        done
      else
        # Ğ ĞµĞ·ĞµÑ€Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ - ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ Ğ¸Ğ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ…
        echo "  hosts:" >> hosts.yml
        IFS=',' read -ra SERVER_LIST <<< "$SERVER_IPS"
        IFS=',' read -ra SERVER_NAMES <<< "$SERVER_NAMES"

        for i in "${!SERVER_LIST[@]}"; do
          server_ip="${SERVER_LIST[$i]}"
          server_name="${SERVER_NAMES[$i]:-server$((i+1))}"
          echo "    $server_name:" >> hosts.yml
          echo "      ansible_host: $server_ip" >> hosts.yml
        done
      fi

      echo "Generated hosts.yml:"
      cat hosts.yml
  artifacts:
    paths:
      - hosts.yml
    expire_in: 1 hour


.job_inj:
  before_script:
    - eval $(ssh-agent -s)
    - echo "$SSH_ROOT_PRIVATE_KEY" | tr -d '\r' | ssh-add -


ğŸ‰ansible_lint_test:
  stage: ğŸ› ï¸ansible_test
  dependencies:
    - ğŸ”¨generate_inventory
  tags:
    - Docker
  extends: .job_inj
  script:
    - ansible --version
    - ansible-lint --version
    - ansible-lint -q --offline
    - ansible all -i hosts.yml -m ping


ğŸš€deploy:
  stage: ğŸš€deploy
  tags:
    - Docker
  when: manual
  dependencies:
    - ğŸ”¨generate_inventory
    - ğŸ‰ansible_lint_test
  extends: .job_inj
  script:
    - |
      echo "Current directory structure:"
      ls -la

      echo "Inventory file:"
      cat hosts.yml

      echo "Running playbook..."
      ansible-playbook -i hosts.yml playbooks/powerdns-install.yml \
      -e "powerdns_backend=pgsql" \
      -e "powerdns_master=true"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

